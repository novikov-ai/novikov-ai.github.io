---
title: –¢–û–ü-10 —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ —Ä–∞–±–æ—Ç–µ —Å –ë–î
slug: database-tips                 
date: 2025-11-15T13:46:04+03:00
draft: false                                 
params:
  author: –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ù–æ–≤–∏–∫–æ–≤                  
  ShowCodeCopyButtons: true
  ShowPostNavLinks: true
  tags: [db, optimization, tips]         
weight: 10
layout: custom-layout                                   
---

–í –Ω–æ—è–±—Ä–µ –±—ã–ª –Ω–∞ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏ Highload++, –æ –∫–æ—Ç–æ—Ä–æ–π –ø–æ–¥—Ä–æ–±–Ω–æ [–ø–∏—Å–∞–ª](https://t.me/time2code/387) –≤ —Ç–µ–ª–µ–≥—Ä–∞–º-–∫–∞–Ω–∞–ª–µ.

–ë—ã–ª–æ –º–Ω–æ–≥–æ —Ö–æ—Ä–æ—à–∏—Ö —Ç–µ–∑–∏—Å–æ–≤ –ø—Ä–æ —Ä–∞–±–æ—Ç—É —Å –ë–î, –Ω–∞ –æ–¥–Ω–æ–º –∏–∑ –¥–æ–∫–ª–∞–¥–æ–≤ –ø—Ä–∏–≤–æ–¥–∏–ª—Å—è —Ç–æ–ø 10. –ù–∏–∂–µ ‚Äî —É–≥–ª—É–±–ª—ë–Ω–Ω—ã–π —Ä–∞–∑–±–æ—Ä –∫–∞–∂–¥–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: —á—Ç–æ –∏–º–µ–Ω–Ω–æ –∏–º–µ–ª –≤ –≤–∏–¥—É —Å–ø–∏–∫–µ—Ä –∏ –∫–∞–∫ —ç—Ç–æ –ø—Ä–∏–º–µ–Ω—è—Ç—å –≤ —Ä–µ–∞–ª—å–Ω–æ —Ä–∞–±–æ—Ç–µ. 

## 1Ô∏è‚É£ **–ö–æ–Ω–Ω–µ–∫—à–µ–Ω—ã ‚Äî —ç—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Ä–µ—Å—É—Ä—Å**

**–°—É—Ç—å:**

–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ TCP-—Å–æ–∫–µ—Ç. –≠—Ç–æ –ø–∞–º—è—Ç—å, –∫—ç—à, –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ –∏–Ω–æ–≥–¥–∞ —Ä–∞–±–æ—á–∏–µ –ø–æ—Ç–æ–∫–∏ –≤ –°–£–ë–î. –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω–Ω–µ–∫—Ç–æ–≤ –ª–µ–≥–∫–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ `too many connections`.

**–ü—Ä–∞–∫—Ç–∏–∫–∞:**

Kubernetes-—Å–µ—Ä–≤–∏—Å –±–µ–∑ –ª–∏–º–∏—Ç–æ–≤ –Ω–∞ –ø—É–ª: –ø—Ä–∏ –ø–∏–∫–µ –∫–∞–∂–¥—ã–π pod –æ—Ç–∫—Ä—ã–ª 100 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π ‚Üí PostgreSQL –¥–æ—à—ë–ª –¥–æ –ª–∏–º–∏—Ç–∞ –∏ –Ω–∞—á–∞–ª –æ—Ç–≤–µ—á–∞—Ç—å –æ—à–∏–±–∫–∞–º–∏.

**–ö–∞–∫ —Ä–µ—à–∞—Ç—å:**

* –í Go: `db.SetMaxOpenConns`, `db.SetMaxIdleConns`, `db.SetConnMaxLifetime`.
* –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ–∫—Å–∏‚Äë–ø—É–ª–µ—Ä—ã (PgBouncer) –≤ —Ä–µ–∂–∏–º–µ transaction pooling –¥–ª—è –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π.
* –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ active/idle conns (Prometheus –º–µ—Ç—Ä–∏–∫–∏ –¥—Ä–∞–π–≤–µ—Ä–∞ –∏–ª–∏ pg_stat_activity).

**–®–∞–±–ª–æ–Ω (Go):**

```go
db.SetMaxOpenConns(50)
db.SetMaxIdleConns(25)
db.SetConnMaxLifetime(30 * time.Minute)
```

---

## 2Ô∏è‚É£ **1 connection = 1 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤ –æ–¥–∏–Ω –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏**

**–°—É—Ç—å:**

–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è ¬´–ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç¬ª —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫ –∫–æ–Ω–Ω–µ–∫—Ç—É. –ï—Å–ª–∏ –≤—ã –Ω–∞—á–∏–Ω–∞–µ—Ç–µ `BEGIN` –∏ –∂–¥—ë—Ç–µ ‚Äî —ç—Ç–æ—Ç –∫–æ–Ω–Ω–µ–∫—Ç –∑–∞–Ω—è—Ç. –ü–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π –∑–∞–Ω—è—Ç—ã–µ –∫–æ–Ω–Ω–µ–∫—Ç—ã –±—ã—Å—Ç—Ä–æ –ø—Ä–∏–≤–æ–¥—è—Ç –∫ –¥–µ–ø—Ä–µ—Å—Å–∏–∏ –ø—É–ª–∞.

**–ü—Ä–∞–∫—Ç–∏–∫–∞:**

–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ—Ç–∫—Ä—ã–≤–∞–ª–∏—Å—å –∑–∞—Ä–∞–Ω–µ–µ, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º –ø–æ –∫–æ–¥—É –¥–µ–ª–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ SELECT'—ã ‚Äî –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π 90% –ø—É–ª–∞ –±—ã–ª–æ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `idle in transaction`.

**–ö–∞–∫ —Ä–µ—à–∞—Ç—å:**

* –î–µ—Ä–∂–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏: `BEGIN` ‚Üí DML ‚Üí `COMMIT/ROLLBACK`.
* –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–∑—ã–≤–∞–π—Ç–µ –≤–Ω–µ—à–Ω–∏–µ I/O (HTTP, heavy CPU) –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
* –ï—Å–ª–∏ –Ω–∞–¥–æ –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –≤–Ω–µ—à–Ω–∏–µ –≤—ã–∑–æ–≤—ã ‚Äî —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ `outbox pattern`.

**Outbox —Å—Ö–µ–º–∞ (—É–ø—Ä–æ—â—ë–Ω–Ω–æ):**

1. –í —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–∏—à–µ–º –¥–∞–Ω–Ω—ã–µ + –∑–∞–ø–∏—Å—å –≤ `outbox` —Ç–∞–±–ª–∏—Ü—É.
2. Commit.
3. –û—Ç–¥–µ–ª—å–Ω—ã–π –≤–æ—Ä–∫–µ—Ä —á–∏—Ç–∞–µ—Ç `outbox` –∏ —à–ª—ë—Ç HTTP/—Å–æ–æ–±—â–µ–Ω–∏—è.

##  3Ô∏è‚É£ **–ß–µ—Ä–µ–∑ connection –Ω–∞–¥–æ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã**

**–°—É—Ç—å:**

Idle —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ ¬´–ø—É—Å—Ç—ã–µ¬ª –æ–∂–∏–¥–∞–Ω–∏—è ‚Äî –±–µ–¥–∞: –æ–Ω–∏ –¥–µ—Ä–∂–∞—Ç locks, –±–ª–æ–∫–∏—Ä—É—é—Ç VACUUM –∏ —Ç—è–Ω—É—Ç –ø—É–ª.

**–ü—Ä–∞–∫—Ç–∏–∫–∞:**

ORM –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞–ª–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –Ω–∞ –≤–µ—Å—å HTTP‚Äë–∑–∞–ø—Ä–æ—Å. –ö–æ–≥–¥–∞ –ª–æ–≥–∏–∫–∞ –¥–µ–ª–∞–ª–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤—ã–∑–æ–≤–æ–≤ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ ‚Äî —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤–∏—Å–µ–ª–∏ –¥–µ—Å—è—Ç–∫–∏ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥. –ü–æ–¥ –ø–∏–∫–æ–≤–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π —ç—Ç–æ –Ω–∞–∫–æ–ø–∏–ª–æ—Å—å –≤ —Å–µ—Ä—å—ë–∑–Ω–æ–µ —Ç–æ—Ä–º–æ–∂–µ–Ω–∏–µ.

**–ö–∞–∫ —Ä–µ—à–∞—Ç—å:**

* –ò–∑–±–µ–≥–∞–π—Ç–µ –∞–≤—Ç–æ‚Äë—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤–æ–∫—Ä—É–≥ –≤—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.
* –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —è–≤–Ω—ã–µ –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
* –í–∫–ª—é—á–∏—Ç–µ `idle_in_transaction_session_timeout` –≤ Postgres, —á—Ç–æ–±—ã –ª–æ–≤–∏—Ç—å –ø—Ä–æ—Å—Ä–æ–∫–∏.

## 4Ô∏è‚É£ **–ù–µ–ª—å–∑—è –¥–µ–ª–∞—Ç—å HTTP‚Äë–∑–∞–ø—Ä–æ—Å—ã –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ**

**–°—É—Ç—å:**

–í–Ω–µ—à–Ω–∏–µ –≤—ã–∑–æ–≤—ã –Ω–µ–Ω–∞–¥—ë–∂–Ω—ã –∏ –º–µ–¥–ª–µ–Ω–Ω—ã. –ï—Å–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –∂–¥—ë—Ç –≤–Ω–µ—à–Ω–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ ‚Äî –æ–Ω–∞ —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã –≤ –ë–î.

**–ü—Ä–∞–∫—Ç–∏–∫–∞:**

–í –æ–¥–Ω–æ–º —Å–µ—Ä–≤–∏—Å–µ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–µ–ª–∞–ª–∏ –≤—ã–∑–æ–≤ –±–∏–ª–ª–∏–Ω–≥–∞. –ë–∏–ª–ª–∏–Ω–≥–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å —Å—Ç–∞–ª –æ—Ç–≤–µ—á–∞—Ç—å 3s –≤–º–µ—Å—Ç–æ 200ms ‚Äî –±–∞–∑–∞ –Ω–∞—á–∞–ª–∞ –¥–µ–≥—Ä–∞–¥–∏—Ä–æ–≤–∞—Ç—å.

**–ö–∞–∫ —Ä–µ—à–∞—Ç—å:**

* Outbox (—Å–º. –≤—ã—à–µ).
* –°–æ–±—ã—Ç–∏—è –ø–æ—Å–ª–µ commit (eventual consistency).
* –ö–æ–º–ø–µ–Ω—Å–∏—Ä—É—é—â–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç.

**–®–∞–±–ª–æ–Ω –¥–ª—è outbox (SQL):**

```sql
BEGIN;
UPDATE orders SET status='paid' WHERE id=?;
INSERT INTO outbox (...) VALUES (...);
COMMIT;
-- –ø–æ—Å–ª–µ commit –æ—Ç–¥–µ–ª—å–Ω—ã–π –≤–æ—Ä–∫–µ—Ä –∏–¥–µ—Ç –≤ –±–∏–ª–ª–∏–Ω–≥
```

---

## 5Ô∏è‚É£ **–ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –º–µ—à–∞—é—Ç –±—ã—Å—Ç—Ä—ã–º**

**–°—É—Ç—å:**

–û–¥–∏–Ω ¬´—Ç—è–∂—ë–ª—ã–π¬ª –∑–∞–ø—Ä–æ—Å (full table scan, —Å–ª–æ–∂–Ω—ã–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏, –∞–≥—Ä–µ–≥–∞—Ü–∏–∏) –∑–∞–±–∏—Ä–∞–µ—Ç CPU / IO / Memory –∏ –º–æ–∂–µ—Ç –≤—ã—Ç–µ—Å–Ω–∏—Ç—å –±—ã—Å—Ç—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã. –≠—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –Ω–∞ —Ä–µ–ø–ª–∏–∫–∞—Ö –∏ –ø—Ä–∏ –æ–±—â–µ–º —Ä–µ—Å—É—Ä—Å–Ω–æ–º –ø—É–ª–µ.

**–ü—Ä–∞–∫—Ç–∏–∫–∞:**

–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å –Ω–∞ 40 –º–ª–Ω —Å—Ç—Ä–æ–∫ –≤ –ø—Ä–æ–¥–µ –∑–∞–ø—É—Å–∫–∞–ª temp‚Äë—Ñ–∞–π–ª—ã –Ω–∞ –¥–∏—Å–∫–µ –∏ –∑–∞–Ω–∏–º–∞–ª 60% CPU. –û–±—ã—á–Ω—ã–µ API –∑–∞–ø—Ä–æ—Å—ã –Ω–∞—á–∞–ª–∏ —Ä–∞—Å—Ç–∏ –≤ latency.

**–ö–∞–∫ —Ä–µ—à–∞—Ç—å:**

* –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `EXPLAIN (ANALYZE, BUFFERS)`.
* –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `statement_timeout` –¥–ª—è user / role –≤ Postgres.
* –ü–µ—Ä–µ–Ω–æ—Å–∏—Ç–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —Ä–µ–ø–ª–∏–∫—É –∏–ª–∏ –≤ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫—É—é –±–∞–∑—É (ClickHouse, DWH).
* –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è, –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∞–≥—Ä–µ–≥–∞—Ç—ã, batch jobs.

## 6Ô∏è‚É£ **–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã**

**–°—É—Ç—å:**

–ò–Ω–¥–µ–∫—Å—ã ‚Äî –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –Ω–æ —Å –ø–æ–±–æ—á–Ω—ã–º–∏ —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏: –æ–Ω–∏ —É—Å–∫–æ—Ä—è—é—Ç —á—Ç–µ–Ω–∏–µ, –∑–∞–º–µ–¥–ª—è—é—Ç –∑–∞–ø–∏—Å—å –∏ –∑–∞–Ω–∏–º–∞—é—Ç –º–µ—Å—Ç–æ.

**–ü—Ä–∞–∫—Ç–∏–∫–∞:**

–í–µ—Ä–æ—è—Ç–Ω–æ, –∫–∞–∂–¥—ã–π —Å—Ç–∞–ª–∫–∏–≤–∞–ª—Å—è —Å –º–µ–¥–ª–µ–Ω–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏ –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∏–ª–∏ –Ω–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞. –ü—Ä–æ –∫–µ–π—Å, –∫–æ–≥–¥–∞ –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π –∏–Ω–¥–µ–∫—Å –ø–æ–º–æ–≥ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É—Å–∫–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å, –ø–∏—Å–∞–ª –≤ –¥—Ä—É–≥–æ–π [—Å—Ç–∞—Ç—å–µ](https://novikov-ai.github.io/ru/posts/postgresql-query-optimization-composite-index/).

**–ö–∞–∫ —Ä–µ—à–∞—Ç—å:**

* –î–µ–ª–∞–π—Ç–µ –∏–Ω–¥–µ–∫—Å—ã –ø–æ —Ä–µ–∞–ª—å–Ω—ã–º –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º `WHERE`/`JOIN`/`ORDER BY`.
* –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–π—Ç–µ composite –∏–Ω–¥–µ–∫—Å—ã, –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–ª–æ–Ω–æ–∫.
* –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ—Ä—è–¥–æ–∫ –∫–æ–ª–æ–Ω–æ–∫ –≤ composite —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç `WHERE` –∏ `ORDER BY`.
* –£–¥–∞–ª—è–π—Ç–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã (pg_stat_user_indexes –ø–æ–º–æ–∂–µ—Ç).

**–®–∞–±–ª–æ–Ω (SQL):**

–ü–ª–æ—Ö–æ–π –≤–∞—Ä–∏–∞–Ω—Ç:
```sql
WHERE user_id = ? AND created_at > ?
-- –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã -> –º–æ–∂–µ—Ç –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è
```

–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:
```sql
CREATE INDEX idx_user_created ON events (user_id, created_at DESC);
```

## 7Ô∏è‚É£ **–ï—Å—Ç—å –∑–∞–ø—Ä–æ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å ‚Äî OR/IS NULL –∏ –¥—Ä.**

**–°—É—Ç—å:**

–û–ø–µ—Ä–∞—Ç–æ—Ä—ã `OR`, `IS NULL`, `NOT IN` –∏ –¥—Ä. —á–∞—Å—Ç–æ –ª–æ–º–∞—é—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤. –ò–Ω–æ–≥–¥–∞ –ø—Ä–æ—Å—Ç–∞—è –∞–ª–≥–µ–±—Ä–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–∞—ë—Ç –æ–≥—Ä–æ–º–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à.

**–¢–∏–ø–∏—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã:**

* `OR` –ø–æ –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º—ã–º –ø–æ–ª—è–º ‚Üí full scan. –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –≤ `UNION ALL` –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `COALESCE`.
* `NOT IN` ‚Üí –ª—É—á—à–µ `NOT EXISTS`.
* `LEFT JOIN` ‚Üí `INNER JOIN`, –µ—Å–ª–∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω match.

**–®–∞–±–ª–æ–Ω (SQL):**

–ü–ª–æ—Ö–æ:
```sql
WHERE user_id = 10 OR user_id IS NULL
```

–õ—É—á—à–µ:
```sql
WHERE COALESCE(user_id, 10) = 10
-- –∏–ª–∏
WHERE user_id = 10
UNION ALL
SELECT ... WHERE user_id IS NULL AND ...
```

## 8Ô∏è‚É£ **–õ—É—á—à–µ –∑–∞—Ä–∞–Ω–µ–µ –ø—Ä–æ–µ–∫—Ç–∏—Ä—É–π—Ç–µ API –ø–æ–¥ keyset pagination**

**–°—É—Ç—å:**

Offset –ø–∞–≥–∏–Ω–∞—Ü–∏—è –¥–µ–≥—Ä–∞–¥–∏—Ä—É–µ—Ç —Å —Ä–æ—Å—Ç–æ–º offset: –°–£–ë–î –≤—ã–Ω—É–∂–¥–µ–Ω–∞ –ø—Ä–æ–±–µ–∂–∞—Ç—å –∏ –æ—Ç–±—Ä–æ—Å–∏—Ç—å `OFFSET N` —Å—Ç—Ä–æ–∫. 

**–ü—Ä–∞–∫—Ç–∏–∫–∞:**

–£ —Å–µ—Ä–≤–∏—Å–∞ —Ö—Ä–∞–Ω–∏–ª–æ—Å—å ~90M —Å–æ–±—ã—Ç–∏–π, API –≤—ã–¥–∞–≤–∞–ª 50 —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ /events?page=N,
offset –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ 1000 = offset 50 000.

–í—Ä–µ–º—è –Ω–∞—Ä–∞—Å—Ç–∞–µ—Ç –ª–∏–Ω–µ–π–Ω–æ. 

**–ö–∞–∫ —Ä–µ—à–∞—Ç—å:**

Keyset (seek) ‚Äî —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∏ –±—ã—Å—Ç—Ä—ã–π —Å–ø–æ—Å–æ–±. –≠—Ç–æ –ø–∞–≥–∏–Ω–∞—Ü–∏—è –Ω–µ –ø–æ –ø–æ–∑–∏—Ü–∏–∏ (offset), –∞ –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é –ø–æ–ª—è, –∫–æ—Ç–æ—Ä–æ–µ —É–∂–µ –µ—Å—Ç—å –≤ –∏–Ω–¥–µ–∫—Å–µ.

–ò–º–µ–µ—Ç —Å–º—ã—Å–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ª–µ–Ω—Ç, –ª–æ–≥–æ–≤, —Ç–∞–±–ª–∏—Ü —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å—Ç—Ä–æ–∫.

**–®–∞–±–ª–æ–Ω (SQL)**
```sql
WHERE (created_at, id) < (last_created_at, last_id)
ORDER BY created_at DESC, id DESC
LIMIT 50;
```

## 9Ô∏è‚É£ **–ü—Ä–∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ë–î –æ–±—Ä–∞—Ç–∏—Ç–µ –æ—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ JSON**

**–°—É—Ç—å:**

JSON –¥–∞—ë—Ç –≥–∏–±–∫–æ—Å—Ç—å, –Ω–æ —Å–∫—Ä—ã–≤–∞–µ—Ç —Å—Ö–µ–º—É. –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏: —Ö—Ä–∞–Ω–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—è –≤ JSON –∏ –∑–∞—Ç–µ–º –æ–∂–∏–¥–∞—Ç—å –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –Ω–∏–º.

**–ö–∞–∫ —Ä–µ—à–∞—Ç—å:**

* JSONB —Ö–æ—Ä–æ—à –¥–ª—è –Ω–µ—á–∞—Å—Ç–æ —Ñ–∏–ª—å—Ç—Ä—É–µ–º—ã—Ö/–ø–æ–∏—Å–∫–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
* –ï—Å–ª–∏ –ø–æ –ø–æ–ª—è–º JSON –Ω—É–∂–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —á–∞—Å—Ç–æ ‚Äî –≤—ã–Ω–µ—Å–∏—Ç–µ –∏—Ö –≤ —Å—Ç–æ–ª–±—Ü—ã (normalization).
* –î–ª—è JSONB –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ GIN –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –∫–ª—é—á–∞–º: `CREATE INDEX ON table USING GIN (data jsonb_path_ops)`.
* –ü–æ–º–Ω–∏—Ç–µ –ø—Ä–æ —Ä–∞–∑–º–µ—Ä –∏ bloat; —á–∞—Å—Ç–æ –ª—É—á—à–µ —è–≤–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞.

**–ü—Ä–∏–º–µ—Ä:**

–ï—Å–ª–∏ `user.preferences->'emails'` –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ WHERE ‚Äî –≤—ã–Ω–µ—Å–∏—Ç–µ `pref_emails` –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü –∏ –∏–Ω–¥–µ–∫—Å–∏—Ä—É–π—Ç–µ.

## üîü **–ù–µ –¥–µ–ª–∞–π—Ç–µ —Ç–∏–ø–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫ ‚Äî –¥–µ–ª–∞–π—Ç–µ –Ω–µ—Ç–∏–ø–∏—á–Ω—ã–µ**

**–°—É—Ç—å:**

–°–ª–µ–¥–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω–∞–º ‚Äî —Ö–æ—Ä–æ—à–æ, –Ω–æ –ø—Ä–æ–¥‚Äë—Å–∏—Å—Ç–µ–º—ã —Ç—Ä–µ–±—É—é—Ç –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫—É –∏ –º–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö. –ò–Ω–æ–≥–¥–∞ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –≤—ã–∏–≥—Ä—ã–≤–∞–µ—Ç.

**–ü—Ä–∏–º–µ—Ä—ã ¬´–Ω–µ—Ç–∏–ø–∏—á–Ω—ã—Ö¬ª –ø–æ–¥—Ö–æ–¥–æ–≤:**

* –®–∞—Ä–¥–∏–Ω–≥ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è contention.
* CQRS: —Ä–∞–∑–¥–µ–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏ –¥–ª—è –∑–∞–ø–∏—Å–∏ –∏ —á—Ç–µ–Ω–∏—è.
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ materialized views + background refresh –≤–º–µ—Å—Ç–æ —Ç—è–∂—ë–ª—ã—Ö –∞–≥—Ä–µ–≥–∞—Ü–∏–π.

**–ù–æ:** –Ω–µ –∏–∑–æ–±—Ä–µ—Ç–∞–π—Ç–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥ –±–µ–∑ –ø—Ä–∏—á–∏–Ω. –ü—Ä–æ—Ñ–∞–π–ª–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏ —Å–Ω–∞—á–∞–ª–∞.

---

## –ó–∞–ø–æ–º–Ω–∏—Ç—å

1. –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–π—Ç–µ –ø—É–ª –∫–æ–Ω–Ω–µ–∫—Ç–æ–≤, —Å—Ç–∞–≤—å—Ç–µ PgBouncer –µ—Å–ª–∏ –Ω—É–∂–Ω–æ.
2. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è = –æ–¥–∏–Ω –∫–æ–Ω–Ω–µ–∫—Ç; –¥–µ—Ä–∂–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∫–æ—Ä–æ—Ç–∫–∏–º–∏.
3. –ù–µ –¥–µ—Ä–∂–∏—Ç–µ –∫–æ–Ω–Ω–µ–∫—Ç –≤ –ø—Ä–æ—Å—Ç–æ–µ –∏ –Ω–µ –¥–µ–ª–∞–π—Ç–µ –≤–Ω–µ—à–Ω–∏–µ –≤—ã–∑–æ–≤—ã –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
4. –í—ã–Ω–µ—Å–∏—Ç–µ HTTP –≤ outbox/–ø–æ—Å–ª–µ commit.
5. –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Ç—è–∂—ë–ª—ã–µ –∑–∞–ø—Ä–æ—Å—ã ‚Äî –Ω–∞ —Ä–µ–ø–ª–∏–∫—É –∏–ª–∏ –≤ DWH.
6. –ò–Ω–¥–µ–∫—Å—ã ‚Äî –ø–æ–¥—É–º–∞–π—Ç–µ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º; composite > –Ω–∞–±–æ—Ä –æ—Ç–¥–µ–ª—å–Ω—ã—Ö.
7. –ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞–π—Ç–µ OR/NOT/IS NULL –≤ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω–¥–µ–∫—Å.
8. –ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ keyset pagination –∑–∞—Ä–∞–Ω–µ–µ.
9. JSON ‚Äî —É–¥–æ–±–Ω–æ, –Ω–æ –Ω–µ –¥–ª—è —á–∞—Å—Ç–æ —Ñ–∏–ª—å—Ç—Ä—É–µ–º—ã—Ö –ø–æ–ª–µ–π.
10. –ü—Ä–æ—Ñ–∏–ª–∏—Ä—É–π—Ç–µ, –∏–∑–º–µ—Ä—è–π—Ç–µ, –∑–∞—Ç–µ–º –ø—Ä–∏–º–µ–Ω—è–π—Ç–µ ¬´–Ω–µ—Ç–∏–ø–∏—á–Ω—ã–µ¬ª –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏—ë–º—ã.

*–ß–∏—Ç–∞–π—Ç–µ –¥—Ä—É–≥–∏–µ –ø–æ—Å—Ç—ã –∏–∑ –º–∏—Ä–∞ –ë–∏–≥ –¢–µ—Ö–∞ –∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –æ–±—Å—É–∂–¥–µ–Ω–∏—é –≤ –¢–µ–ª–µ–≥—Ä–∞–º: [@time2code](https://t.me/time2code)*